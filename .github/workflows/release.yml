name: Create Release Package

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

permissions:
  contents: write
  packages: write
  pull-requests: read

jobs:
  create-release:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up environment
      run: |
        echo "RELEASE_VERSION=${GITHUB_REF#refs/tags/}" >> $GITHUB_ENV
        echo "PACKAGE_NAME=poopDeck-${GITHUB_REF#refs/tags/}.mpackage" >> $GITHUB_ENV
        
    - name: Update version in files
      run: |
        VERSION=${GITHUB_REF#refs/tags/v}
        echo "$VERSION" > VERSION
        sed -i "s/\"version\": \".*\"/\"version\": \"$VERSION\"/" mfile
        
    - name: Create package structure
      run: |
        mkdir -p package
        cp -r src package/
        cp mfile package/
        cp VERSION package/
        
    - name: Create .mpackage file
      run: |
        cd package
        zip -r "../${PACKAGE_NAME}" .
        cd ..
        
    - name: Run tests
      run: |
        # Install Lua and Busted if available
        sudo apt-get update
        sudo apt-get install -y lua5.3 luarocks || true
        
        # Try to run tests if tools are available
        if command -v luarocks >/dev/null 2>&1; then
          sudo luarocks install busted || true
          if command -v busted >/dev/null 2>&1; then
            echo "Running test suite..."
            busted --verbose spec/ || echo "Tests completed with issues (non-blocking for release)"
          else
            echo "Busted not available, skipping tests"
          fi
        else
          echo "LuaRocks not available, skipping tests"
        fi
        
    - name: Generate release notes
      run: |
        cat > release_notes.md << 'EOF'
        # ðŸš¢ poopDeck ${RELEASE_VERSION}
        
        **Complete Achaea Seafaring Automation Package**
        
        ## ðŸŽ¯ Key Features
        
        - ðŸ™ **Seamonster Auto-Fire**: Intelligent weapon management and combat automation
        - ðŸŽ£ **Smart Fishing System**: Auto-resume when fish escape, flexible bait management
        - ðŸš¢ **Ship Navigation**: Complete sailing, docking, and maintenance automation
        - ðŸªŸ **Status Windows**: Real-time multi-window status display system
        - ðŸ”” **Notifications**: 20-minute seamonster spawn cycle alerts
        - ðŸ“¢ **Spam Reduction**: Intelligent message filtering and quiet mode
        - ðŸ›¡ï¸ **Error Recovery**: Automatic error handling and service recovery
        - âš™ï¸ **Full Integration**: Complete command system with help documentation
        
        ## ðŸ“¦ Installation
        
        1. **Download** the `poopDeck-${RELEASE_VERSION}.mpackage` file below
        2. **Install in Mudlet**: Drag and drop onto Mudlet or use Package Manager
        3. **Restart Mudlet** to complete installation
        4. **Type `poopsail`** to verify installation and see available commands
        
        ## ðŸŽ£ Quick Start
        
        ```lua
        # Basic fishing setup
        fishbait bass
        fishsource tank
        fish
        
        # Seamonster combat
        seaweapon ballista
        autosea
        
        # Status windows
        poopwindows
        ```
        
        ## ðŸ“š Documentation
        
        - **Installation Guide**: Complete setup instructions
        - **User Guide**: Feature documentation and examples
        - **Configuration Guide**: Customization options
        - **Troubleshooting**: Common issues and solutions
        
        ## ðŸ”„ What's New in This Release
        
        See [CHANGELOG.md](CHANGELOG.md) for detailed changes and improvements.
        
        ## âš™ï¸ Requirements
        
        - **Mudlet 4.0+** (latest version recommended)
        - **Achaea character** with sailing access
        - **GMCP enabled** in Achaea (`CONFIG GMCP ON`)
        
        ## ðŸ†˜ Support
        
        - ðŸ“– **Documentation**: Check the included guides
        - ðŸ› **Issues**: Report problems via GitHub Issues
        - ðŸ’¬ **Community**: Discuss on Mudlet forums
        
        ---
        
        **ðŸš¢âš“ðŸŽ£ Ready to enhance your Achaea seafaring adventures!**
        EOF
        
    - name: Create Release
      uses: softprops/action-gh-release@v2
      with:
        name: "poopDeck ${{ env.RELEASE_VERSION }}"
        body_path: release_notes.md
        files: |
          ${{ env.PACKAGE_NAME }}
          INSTALLATION.md
          USER_GUIDE.md
          CONFIGURATION.md
          TROUBLESHOOTING.md
          CHANGELOG.md
        draft: false
        prerelease: false
        token: ${{ secrets.GITHUB_TOKEN }}
        
    - name: Update package info
      run: |
        echo "âœ… Release package created: ${PACKAGE_NAME}"
        echo "ðŸ“¦ Package size: $(du -h ${PACKAGE_NAME} | cut -f1)"
        echo "ðŸ·ï¸  Release version: ${RELEASE_VERSION}"
        echo "ðŸ“ Files included:"
        unzip -l "${PACKAGE_NAME}" | head -20